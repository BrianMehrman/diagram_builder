# Story 5.5-9: End-to-End Codebase Import Validation

## Story

**ID:** 5.5-9
**Key:** 5.5-9-codebase-import-validation
**Title:** Validate codebase import feature end-to-end across all layers
**Epic:** Epic 5.5 - Foundation Cleanup
**Phase:** Foundation & Quality Gates
**Priority:** CRITICAL

**Description:**

Create comprehensive end-to-end validation tests for the codebase import feature that spans Epic 3 (Parser), Epic 4 (API), and Epic 5 (UI). This story validates that Stories 3-4, 5.5-4, and 5.5-5 are actually working together as an integrated system.

**Context from Code Review (2026-01-03):**
The code review revealed that while implementation exists for all three layers, there is NO end-to-end validation that the complete flow works:
1. UI: User imports codebase → API receives request
2. API: Triggers parser → Parser clones/scans repository
3. Parser: Builds dependency graph → Returns IVM
4. API: Stores in Neo4j → Updates codebase status
5. UI: Polls status → Displays success → Shows imported codebase

**This story exists because we committed to NEVER marking stories complete without validation.**

---

## Acceptance Criteria

- **AC-1:** End-to-end integration test exists
  - Test covers complete flow from UI action to Neo4j storage
  - Uses real parser (not mocked)
  - Uses real API endpoints (not mocked)
  - Uses real Neo4j database (test database)
  - Test is automated and repeatable

- **AC-2:** Local path import validated
  - Test imports a local directory
  - Parser scans directory and finds files
  - API stores parsed graph in Neo4j
  - Verifies Repository, File, Class nodes created
  - Verifies relationships (CONTAINS, DEPENDS_ON, etc.) created

- **AC-3:** Git repository import validated
  - Test imports a Git repository (small public repo)
  - Parser clones repository
  - API stores parsed graph in Neo4j
  - Cleanup verified (temp directory removed)
  - Handles authentication (if private repo)

- **AC-4:** Async processing validated
  - Test verifies status transitions: pending → processing → completed
  - API returns immediately with pending status
  - Background processing updates status
  - Client can poll status endpoint
  - Test waits for completion (with timeout)

- **AC-5:** Error handling validated
  - Test invalid path (should fail gracefully)
  - Test invalid Git URL (should fail gracefully)
  - Test parser failure (malformed code)
  - Status shows "failed" with error message
  - No partial data in Neo4j

- **AC-6:** Performance requirements met
  - Small repository (<100 files) imports in <30 seconds
  - Status updates propagate in <1 second
  - No memory leaks during import
  - Temp directories cleaned up on success AND failure

- **AC-7:** Stories 3-4, 5.5-4, 5.5-5 validated complete
  - After ALL tests pass, update story statuses:
    - Story 3-4: review → done
    - Story 5.5-4: review → done
    - Story 5.5-5: review → done
  - Sprint-status.yaml updated
  - Test evidence documented in story files

---

## Tasks/Subtasks

### Task 1: Create end-to-end test infrastructure
- [ ] Create `tests/e2e/codebase-import-integration.spec.ts`
- [ ] Setup test fixtures (small test repositories)
- [ ] Setup Neo4j test database isolation
- [ ] Create test helper utilities (wait for status, cleanup, etc.)
- [ ] Ensure tests can run in CI/CD

### Task 2: Implement local path import test
- [ ] Create test fixture: small TypeScript project (5-10 files)
- [ ] Test: Import local path via API
- [ ] Verify: Files discovered by parser
- [ ] Verify: Graph stored in Neo4j
- [ ] Verify: Repository, File, Class nodes exist
- [ ] Verify: Relationships correct
- [ ] Verify: Status transitions to "completed"

### Task 3: Implement Git repository import test
- [ ] Identify small public GitHub repository for testing
- [ ] Test: Import Git URL via API
- [ ] Verify: Repository cloned
- [ ] Verify: Graph stored in Neo4j
- [ ] Verify: Cleanup (temp directory removed)
- [ ] Test with specific branch
- [ ] Test with default branch

### Task 4: Implement async processing validation
- [ ] Test: Status immediately returns "pending"
- [ ] Test: Poll status endpoint until completion
- [ ] Test: Status transitions: pending → processing → completed
- [ ] Test: Timeout after 60 seconds if not complete
- [ ] Verify: Background processing actually happens
- [ ] Verify: Status updates propagate to database

### Task 5: Implement error handling tests
- [ ] Test: Invalid local path
- [ ] Test: Invalid Git URL
- [ ] Test: Repository with parse errors
- [ ] Test: Network timeout (Git clone)
- [ ] Verify: Status shows "failed"
- [ ] Verify: Error message is meaningful
- [ ] Verify: No partial data in Neo4j
- [ ] Verify: Cleanup happens on failure

### Task 6: Validate performance requirements
- [ ] Test: Small repo (<100 files) completes in <30 seconds
- [ ] Test: Status updates in <1 second
- [ ] Test: No memory leaks (run multiple imports)
- [ ] Verify: Temp directories always cleaned up
- [ ] Document actual performance metrics

### Task 7: Validate Stories 3-4, 5.5-4, 5.5-5 complete
- [ ] Run ALL tests - verify 100% pass rate
- [ ] Update Story 3-4 status: review → done
- [ ] Update Story 3-4 tasks: mark all [x]
- [ ] Update Story 5.5-4 status: review → done
- [ ] Update Story 5.5-5 status: review → done
- [ ] Update Story 5.5-5 tasks: mark all [x]
- [ ] Update sprint-status.yaml: all three stories marked "done"
- [ ] Document test evidence in each story file

---

## Dev Notes

### Context from Code Review

**Code Exists But Not Validated:**
- ✅ Parser: `packages/parser/src/repository/` - 3 modules implemented
- ✅ API: `packages/api/src/services/codebase-service.ts` - 438 lines
- ✅ UI: `packages/ui/src/features/workspace/ImportCodebaseModal.tsx` - 357 lines

**Missing:**
- ❌ No test validates UI → API → Parser → Neo4j → UI works end-to-end
- ❌ Background processing has try-catch that logs but doesn't fail request
- ❌ No validation that Parser output matches API expectations
- ❌ No performance measurement

### Implementation Guidance

**E2E Test Structure:**
```typescript
// tests/e2e/codebase-import-integration.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Codebase Import Integration', () => {
  test('should import local directory end-to-end', async ({ page }) => {
    // 1. Navigate to workspace
    await page.goto('/workspace/default-workspace');

    // 2. Open import modal
    await page.click('button:has-text("Import Codebase")');

    // 3. Fill form
    await page.click('input[value="local"]');
    await page.fill('input[name="source"]', '/path/to/test/fixture');

    // 4. Submit
    await page.click('button[type="submit"]');

    // 5. Verify status shows "pending"
    await expect(page.locator('text=Import started')).toBeVisible();

    // 6. Wait for completion (poll status)
    await page.waitForSelector('text=Import complete', { timeout: 30000 });

    // 7. Verify codebase appears in list
    await expect(page.locator('text=test-fixture')).toBeVisible();

    // 8. Verify in Neo4j (via API query)
    const response = await page.request.get('/api/workspaces/default-workspace/codebases');
    const data = await response.json();
    expect(data.codebases.length).toBeGreaterThan(0);
    expect(data.codebases[0].status).toBe('completed');
  });
});
```

**Neo4j Validation:**
```typescript
// Verify graph structure in Neo4j
async function verifyGraphInNeo4j(codebaseId: string) {
  const result = await runQuery(`
    MATCH (c:Codebase {id: $codebaseId})-[:PARSED_INTO]->(r:Repository)
    MATCH (r)<-[:BELONGS_TO]-(f:File)
    MATCH (f)<-[:BELONGS_TO]-(cl:Class)
    RETURN
      count(DISTINCT r) as repositories,
      count(DISTINCT f) as files,
      count(DISTINCT cl) as classes
  `, { codebaseId });

  expect(result[0].repositories).toBe(1);
  expect(result[0].files).toBeGreaterThan(0);
  expect(result[0].classes).toBeGreaterThan(0);
}
```

**Test Fixtures:**
Create small test repository:
```
tests/fixtures/test-codebase/
├── src/
│   ├── index.ts
│   ├── utils/
│   │   └── helpers.ts
│   └── models/
│       └── User.ts
└── package.json
```

### Critical Constraints

- **MUST validate end-to-end** - Not just unit tests
- **MUST use real components** - No mocking of parser, API, or database
- **MUST validate all three stories** - 3-4, 5.5-4, 5.5-5
- **100% pass rate required** - Cannot mark stories done with failing tests
- **Document evidence** - Test results must be recorded in story files

### Dependencies

- **Depends on:**
  - Story 3-4 implementation (parser repository integration)
  - Story 5.5-4 implementation (codebase import API)
  - Story 5.5-5 implementation (codebase import UI)
- **Blocks:**
  - Epic 3 completion (Story 3-4 not validated)
  - Epic 5.5 completion (Stories 5.5-4, 5.5-5 not validated)

### Testing Requirements

**Test Categories:**
1. **Integration Tests** - API → Parser → Neo4j
2. **E2E Tests** - UI → API → Parser → Neo4j → UI
3. **Performance Tests** - Measure import time, verify <30s for small repos
4. **Error Tests** - Verify graceful failure handling

**Success Criteria:**
- ALL tests pass (100% pass rate)
- No flaky tests (5 consecutive runs without failures)
- Performance requirements met
- Error handling verified

### Owner and Estimate

- **Owner:** Dana (QA Engineer) + Charlie (Senior Dev for Neo4j validation)
- **Estimated Effort:** 1-2 days
- **Priority:** CRITICAL - Blocks Epic 3 and Epic 5.5 completion

---

## Dev Agent Record

### Implementation Plan
<!-- AI Dev Agent: Document high-level approach before implementation -->

### Debug Log
<!-- AI Dev Agent: Record issues encountered and resolutions -->

### Completion Notes
<!-- AI Dev Agent: Summarize what was implemented and tested -->

---

## File List

<!-- AI Dev Agent: List ALL new/modified/deleted files (relative paths) -->
<!-- Format: [NEW|MOD|DEL] path/to/file.ts -->

---

## Change Log

<!-- AI Dev Agent: Add entry after each implementation session -->
<!-- Format: - Description of changes (Date: YYYY-MM-DD) -->

---

## Status

**Current Status:** not-started
**Created:** 2026-01-03
**Last Updated:** 2026-01-03
**Completion Criteria:** ALL tests pass, Stories 3-4, 5.5-4, 5.5-5 marked done
