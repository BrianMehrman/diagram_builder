# Story 5.5-2: Authentication Development Mode

## Story

**ID:** 5.5-2
**Key:** 5.5-2-authentication-dev-mode
**Title:** Implement development mode authentication bypass and fix JWT handling
**Epic:** Epic 5.5 - Foundation Cleanup
**Phase:** Foundation & Quality Gates

**Description:**

Fix the critical authentication issue discovered in Epic 5 retrospective where users cannot login to access UI features. Implement a development mode authentication bypass (like the API's dev-user pattern) and fix JWT token handling and refresh logic.

This is the highest priority story as it unblocks user access to all Epic 5 features.

---

## Acceptance Criteria

- **AC-1:** Development mode authentication bypass implemented
  - In development environment, users can bypass login
  - Automatically authenticated as dev-user when NODE_ENV=development
  - Toggle or flag to enable/disable for testing
  - Matches API's dev-user pattern behavior

- **AC-2:** JWT token handling fixed
  - JWT tokens correctly stored in browser
  - Token included in API requests
  - Token refresh logic working
  - Expired token handling with auto-redirect to login

- **AC-3:** Login/logout flow works end-to-end
  - User can login with credentials
  - JWT token obtained and stored
  - User can access protected routes
  - User can logout and token cleared
  - Redirect to login when unauthenticated

- **AC-4:** Integration with API auth
  - Correctly uses API authentication endpoints
  - Handles API auth errors gracefully
  - Works with API's dev-user fallback
  - Token format matches API expectations

- **AC-5:** Authentication documentation
  - Document dev mode authentication setup
  - Document environment variable configuration
  - Troubleshooting guide for auth issues
  - Examples of testing with/without auth

- **AC-6:** Comprehensive tests
  - Unit tests for auth utilities
  - Component tests for ProtectedRoute
  - E2E test for login flow
  - E2E test for protected route access
  - All tests passing 100%

---

## Tasks/Subtasks

### Task 1: Analyze current authentication implementation
- [ ] Review existing ProtectedRoute.tsx implementation
- [ ] Review API authentication endpoints and behavior
- [ ] Identify specific JWT handling issues
- [ ] Document current behavior vs expected behavior

### Task 2: Implement development mode bypass
- [ ] Add environment detection (NODE_ENV)
- [ ] Create dev mode auth utility
- [ ] Auto-set dev-user token in development
- [ ] Add configuration option to disable if needed
- [ ] Test dev mode bypass works

### Task 3: Fix JWT token storage and retrieval
- [ ] Implement secure token storage (localStorage or httpOnly cookie)
- [ ] Create auth token utility functions
- [ ] Add token retrieval for API requests
- [ ] Handle token expiration detection
- [ ] Test token persistence across page reloads

### Task 4: Fix JWT token refresh logic
- [ ] Implement token refresh mechanism
- [ ] Add refresh token endpoint integration
- [ ] Handle refresh failures gracefully
- [ ] Test token refresh before expiration

### Task 5: Fix login/logout flow
- [ ] Verify login endpoint integration
- [ ] Store JWT token on successful login
- [ ] Redirect to intended route after login
- [ ] Clear token on logout
- [ ] Redirect to login on logout
- [ ] Test complete login/logout cycle

### Task 6: Update ProtectedRoute component
- [ ] Check authentication status correctly
- [ ] Redirect to login if not authenticated
- [ ] Allow dev mode bypass
- [ ] Handle token validation
- [ ] Test ProtectedRoute with various scenarios

### Task 7: Add authentication documentation
- [ ] Document dev mode setup
- [ ] Document environment variables
- [ ] Add troubleshooting guide
- [ ] Provide usage examples

### Task 8: Write comprehensive tests
- [ ] Unit tests for auth utilities
- [ ] Component tests for ProtectedRoute
- [ ] E2E test for login flow
- [ ] E2E test for protected routes
- [ ] E2E test for logout
- [ ] E2E test for dev mode bypass
- [ ] Verify all tests pass

---

## Dev Notes

### Context from Retrospective

**CRITICAL ISSUE:** Users cannot login to access Epic 5 features. Authentication blocks all UI access.

Key findings:
- API has dev-user fallback in development (middleware/auth.ts)
- UI does not have equivalent dev mode bypass
- JWT token handling broken or incomplete
- ProtectedRoute blocks access without working auth
- E2E tests couldn't run because auth blocked everything

### Current Implementation

**Files to Review:**
- `packages/ui/src/routes/ProtectedRoute.tsx`
- `packages/ui/src/routes/index.tsx`
- `packages/api/src/middleware/auth.ts` (reference for dev mode pattern)

**API Dev Mode Pattern (from auth.ts:24-32):**
```typescript
// In development, allow requests without auth and use a default user
if (isDevelopment && !authHeader) {
  req.user = {
    userId: 'dev-user',
    iat: Math.floor(Date.now() / 1000),
    exp: Math.floor(Date.now() / 1000) + 86400,
  }
  next()
  return
}
```

### Implementation Guidance

**Dev Mode Auth Utility:**
```typescript
// src/shared/utils/auth.ts
export function getAuthToken(): string | null {
  const isDevelopment = import.meta.env.MODE === 'development';
  const devModeEnabled = import.meta.env.VITE_DEV_AUTH !== 'false';

  if (isDevelopment && devModeEnabled) {
    // Return mock dev token or use API without token
    // API will auto-assign dev-user
    return 'dev-mode';
  }

  // In production, get real token
  return localStorage.getItem('auth_token');
}

export function isAuthenticated(): boolean {
  const token = getAuthToken();
  if (token === 'dev-mode') return true;
  if (!token) return false;

  // Validate token expiration
  try {
    const payload = JSON.parse(atob(token.split('.')[1]));
    return payload.exp * 1000 > Date.now();
  } catch {
    return false;
  }
}
```

**Updated ProtectedRoute:**
```typescript
// src/routes/ProtectedRoute.tsx
import { Navigate } from 'react-router-dom';
import { isAuthenticated } from '@/shared/utils/auth';

export function ProtectedRoute({ children }: { children: React.ReactNode }) {
  if (!isAuthenticated()) {
    return <Navigate to="/login" replace />;
  }

  return <>{children}</>;
}
```

**API Client Integration:**
```typescript
// src/features/api-client/client.ts
import { getAuthToken } from '@/shared/utils/auth';

export async function apiRequest(endpoint: string, options: RequestInit = {}) {
  const token = getAuthToken();

  const headers: HeadersInit = {
    'Content-Type': 'application/json',
    ...options.headers,
  };

  // Only add Authorization header in production or if real token exists
  if (token && token !== 'dev-mode') {
    headers['Authorization'] = `Bearer ${token}`;
  }

  // In dev mode with 'dev-mode' token, API will auto-assign dev-user

  const response = await fetch(`${API_BASE_URL}${endpoint}`, {
    ...options,
    headers,
  });

  if (response.status === 401) {
    // Token expired or invalid
    localStorage.removeItem('auth_token');
    window.location.href = '/login';
  }

  return response;
}
```

### Critical Constraints

- **Must match API dev mode pattern** - Consistency between frontend and backend
- **Must not compromise security** - Dev mode only in development environment
- **Must be configurable** - Can disable dev mode for testing auth flows
- **Must fix JWT handling** - Token storage, refresh, validation all working
- **Must enable e2e testing** - Tests need to pass auth to test features

### Dependencies

- **Depends on:** Story 5.5-1 (Database Seed Data) - needs dev-user to exist
- **Blocks:** Story 5.5-3 (E2E Test Validation) - tests can't run without auth working

### Owner and Estimate

- **Owner:** Charlie
- **Estimated Effort:** 2 days
- **Priority:** Critical

---

## Dev Agent Record

### Implementation Plan

_This section will be populated by the dev agent during implementation_

### Debug Log

_This section will be populated by the dev agent during implementation_

### Completion Notes

_This section will be populated by the dev agent after completion_

---

## File List

_This section will be populated by the dev agent with all new, modified, or deleted files_

---

## Change Log

_This section will be populated by the dev agent with implementation changes_

---

## Status

**Current Status:** not-started
**Created:** 2026-01-02
**Last Updated:** 2026-01-02
