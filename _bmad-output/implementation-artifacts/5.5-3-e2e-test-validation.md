# Story 5.5-3: E2E Test Validation & Stabilization

## Story

**ID:** 5.5-3
**Key:** 5.5-3-e2e-test-validation
**Title:** Validate and stabilize all end-to-end tests
**Epic:** Epic 5.5 - Foundation Cleanup
**Phase:** Foundation & Quality Gates

**Description:**

Run all existing Playwright e2e tests against the live system and fix flaky or failing tests. Add complete user journey tests (login → workspace → features) to validate Epic 5 features are actually accessible. Achieve 95%+ pass rate across 5 consecutive runs.

This addresses the critical gap discovered in Epic 5 retrospective: e2e tests exist but were never validated against a running system.

---

## Acceptance Criteria

- **AC-1:** All existing e2e tests run successfully
  - Tests execute against running API and UI
  - Database properly seeded before test runs
  - Authentication working for test scenarios
  - 95%+ pass rate across 5 consecutive runs

- **AC-2:** Flaky tests identified and fixed
  - API change-related failures fixed
  - Timing issues resolved
  - Race conditions eliminated
  - Assertion improvements for stability

- **AC-3:** Complete user journey tests added
  - Login → workspace selection → workspace page
  - Login → canvas visualization → node selection
  - Login → export feature → format selection
  - Login → viewpoint creation → viewpoint sharing
  - All critical user paths covered

- **AC-4:** E2E test documentation updated
  - How to run e2e tests locally
  - Database setup requirements
  - Environment configuration
  - Troubleshooting common issues
  - CI/CD integration guidelines

- **AC-5:** E2E testing added to definition of done
  - Story completion checklist updated
  - E2E test requirement clearly stated
  - Pass criteria defined (95%+ pass rate)
  - Integration with sprint-status workflow

---

## Tasks/Subtasks

### Task 1: Setup and validate e2e test environment
- [ ] Verify Playwright installation and configuration
- [ ] Ensure database is seeded before tests
- [ ] Confirm API server running on correct port
- [ ] Confirm UI server running on correct port
- [ ] Test basic Playwright functionality

### Task 2: Run existing e2e tests and document failures
- [ ] Run tests/e2e/app-smoke.spec.ts
- [ ] Run tests/e2e/canvas-visualization.spec.ts
- [ ] Run tests/e2e/workspace-management.spec.ts
- [ ] Document all failures with error messages
- [ ] Categorize failures (auth, API, timing, assertions)

### Task 3: Fix authentication-related test failures
- [ ] Update tests to use dev mode auth or login flow
- [ ] Add authentication helper utilities for tests
- [ ] Ensure tests can bypass auth in test environment
- [ ] Verify all tests can reach protected routes

### Task 4: Fix API change-related test failures
- [ ] Update API endpoint expectations
- [ ] Fix changed response formats
- [ ] Update data structure assertions
- [ ] Synchronize with current API implementation

### Task 5: Fix timing and flaky test issues
- [ ] Add proper wait conditions
- [ ] Replace arbitrary timeouts with smart waits
- [ ] Fix race conditions in async operations
- [ ] Add retry logic where appropriate
- [ ] Increase test stability

### Task 6: Add complete user journey tests
- [ ] Test: Login → workspace selection → workspace page
- [ ] Test: Login → canvas → node selection → details panel
- [ ] Test: Login → export dialog → format selection → export
- [ ] Test: Login → viewpoint create → save → load
- [ ] Test: Login → collaboration → multi-user session
- [ ] Ensure each test validates end-to-end user experience

### Task 7: Achieve 95%+ pass rate stability
- [ ] Run test suite 5 consecutive times
- [ ] Track pass/fail rates
- [ ] Fix any remaining flaky tests
- [ ] Achieve 95%+ pass rate target
- [ ] Document final test coverage

### Task 8: Update e2e test documentation
- [ ] Write "How to Run E2E Tests" guide
- [ ] Document database setup requirements
- [ ] Add environment variable configuration
- [ ] Create troubleshooting guide
- [ ] Add CI/CD integration notes

### Task 9: Update definition of done
- [ ] Add e2e test requirement to DoD checklist
- [ ] Define pass criteria (95%+ pass rate)
- [ ] Document when to run e2e tests
- [ ] Integrate with sprint-status workflow

---

## Dev Notes

### Context from Retrospective

**CRITICAL GAP:** E2E test files exist but were never validated against running system. Stories marked complete without verifying users can access features.

Key findings:
- E2E tests written but not run against live system
- Authentication blocked test execution
- API changes broke tests but nobody noticed
- Definition of done didn't include e2e validation
- 93% story completion meaningless if features inaccessible

### Existing E2E Tests

**Test Files:**
- `tests/e2e/app-smoke.spec.ts` - Basic app loading and navigation
- `tests/e2e/canvas-visualization.spec.ts` - 3D canvas rendering tests
- `tests/e2e/workspace-management.spec.ts` - Workspace CRUD tests

**Expected Issues:**
- Authentication blocking all protected routes
- API endpoints changed during Epic 4/5 parallel work
- Database missing seed data tests expect
- Timing issues from async operations

### Implementation Guidance

**E2E Test Environment Setup:**
```bash
# In package.json or test setup script
# 1. Start Neo4j and Redis (docker-compose)
# 2. Seed database
# 3. Start API server
# 4. Start UI server
# 5. Run Playwright tests
```

**Auth Helper for Tests:**
```typescript
// tests/e2e/helpers/auth.ts
export async function loginAsDevUser(page: Page) {
  const isDev = process.env.NODE_ENV === 'development';

  if (isDev) {
    // Dev mode: auth should auto-bypass
    await page.goto('/');
    // Should be automatically authenticated
  } else {
    // Test mode: perform actual login
    await page.goto('/login');
    await page.fill('[name="username"]', 'dev-user');
    await page.fill('[name="password"]', 'test-password');
    await page.click('button[type="submit"]');
    await page.waitForURL('/');
  }
}
```

**Complete User Journey Test Example:**
```typescript
// tests/e2e/user-journeys/workspace-access.spec.ts
import { test, expect } from '@playwright/test';
import { loginAsDevUser } from '../helpers/auth';

test.describe('Workspace Access Journey', () => {
  test('user can login and access workspace', async ({ page }) => {
    // Login
    await loginAsDevUser(page);

    // Should be on home page
    await expect(page).toHaveURL('/');

    // Should see workspaces list
    await expect(page.locator('h1')).toContainText('Workspaces');

    // Click on default workspace
    await page.click('text=Default Workspace');

    // Should navigate to workspace page
    await expect(page).toHaveURL(/\/workspace\/.+/);

    // Should see canvas
    await expect(page.locator('canvas')).toBeVisible();

    // Validates: login → workspace list → workspace page → canvas
  });
});
```

**Stability Patterns:**
```typescript
// Instead of arbitrary timeouts
await page.waitForTimeout(1000); // ❌ BAD

// Use smart waits
await page.waitForSelector('.workspace-card'); // ✅ GOOD
await page.waitForResponse(resp => resp.url().includes('/api/workspaces')); // ✅ GOOD
await expect(page.locator('.loading')).not.toBeVisible(); // ✅ GOOD
```

### Critical Constraints

- **Must achieve 95%+ pass rate** - Target is 95% across 5 consecutive runs
- **Must test complete user journeys** - Not just isolated features
- **Must fix flaky tests** - No intermittent failures
- **Must document test execution** - Others need to run tests easily
- **Must update definition of done** - E2E validation required for completion

### Dependencies

- **Depends on:** Story 5.5-1 (Database Seed Data) - tests need test data
- **Depends on:** Story 5.5-2 (Authentication) - tests need to pass auth
- **Blocks:** Epic 5 completion - validates Epic 5 features actually work

### Owner and Estimate

- **Owner:** Dana
- **Estimated Effort:** 2-3 days
- **Priority:** High

---

## Dev Agent Record

### Implementation Plan

_This section will be populated by the dev agent during implementation_

### Debug Log

_This section will be populated by the dev agent during implementation_

### Completion Notes

_This section will be populated by the dev agent after completion_

---

## File List

_This section will be populated by the dev agent with all new, modified, or deleted files_

---

## Change Log

_This section will be populated by the dev agent with implementation changes_

---

## Status

**Current Status:** not-started
**Created:** 2026-01-02
**Last Updated:** 2026-01-02
